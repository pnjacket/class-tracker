<div class="class-panel">
  <select [(ngModel)]="activeClassId" (change)="onClassChange()">
    <option *ngFor="let c of classes" [value]="c.classId">{{c.title}}</option>
  </select>

  <button (click)="openCreateClassDialog()">+ New Class</button>
  <button (click)="renameActiveClass()" [disabled]="!activeClass">Rename</button>
  <button (click)="deleteActiveClass()" [disabled]="!activeClass">Delete</button>
  <button (click)="openCriteriaEditor()" [disabled]="!activeClass">Edit Criteria</button>
  <button (click)="exportClass()" [disabled]="!activeClass">Export Class</button>
  <button (click)="exportCsv()" [disabled]="!activeClass">Export CSV</button>
  <input type="file" #fileInput style="display:none" (change)="importClasses($event)" />
  <criteria-editor *ngIf="showCriteriaEditor"
    [criteria]="activeClass?.criteria || []"
    (save)="onCriteriaSaved($event)"
    (cancel)="onCriteriaCancel()">
  </criteria-editor>
  <button (click)="triggerImport()">Import Classes</button>
</div>

<div *ngIf="activeClass" class="view-panel">
  <label>Date:&nbsp;</label>
  <select [ngModel]="activeView?.date" (ngModelChange)="onViewChange($event)">
    <option *ngFor="let v of activeClass.views" [value]="v.date">{{v.date}}</option>
  </select>
  <button (click)="addView()">Add Date</button>
  <button (click)="removeView(activeView?.date)" [disabled]="!activeView">Remove Date</button>
</div>

<!-- Grid Configuration -->
<div class="config-panel" *ngIf="activeClass">
  <label>Rows:
    <input type="number" [(ngModel)]="activeClass.rows" min="1" (change)="rebuildAllViews()" />
  </label>
  
  <label>Cols:
    <input type="number" [(ngModel)]="activeClass.cols" min="1" (change)="rebuildAllViews()" />
  </label>
</div>

<!-- Classroom Grid -->
<div class="grid" *ngIf="activeView"
     [style.gridTemplateRows]="'repeat(' + activeClass.rows + ', 1fr)'"
     [style.gridTemplateColumns]="'repeat(' + activeClass.cols + ', 1fr)'">
  <ng-container *ngFor="let row of activeView.grid; let rIdx = index">
    <ng-container *ngFor="let cell of row; let cIdx = index">
      <div class="cell"
           [class.filled]="!!cell.student"
           (click)="onCellClick(cell)"
           (dragover)="$event.preventDefault()"
           (drop)="onDrop(cell)">

        <ng-container *ngIf="cell.student">
          <span class="name" draggable="true" (dragstart)="onDragStart($event, cell)" >{{cell.student.name}}</span>
          <button class="del-btn" (click)="$event.stopPropagation(); deleteStudent(cell)">âœ•</button>

          <div class="counter-area">
            <div *ngFor="let key of getStudentCounterKeys(cell.student); let i = index"
                 class="criterion-line"
                 [ngClass]="{'odd': i % 2 === 0, 'even': i % 2 !== 0}">
              <div class="crit-name">{{key}}</div>

              <!-- Counter type -->
              <ng-container *ngIf="(getCriterion(key)?.type) === 'counter'">
                <div class="counter-controls">
                  <button (click)="$event.stopPropagation(); decrementKey(cell, key)">-</button>
                  <span class="count-value">{{cell.student.counters[key]}}</span>
                  <button (click)="$event.stopPropagation(); incrementKey(cell, key)">+</button>
                </div>
              </ng-container>

              <!-- Predefined type -->
              <ng-container *ngIf="(getCriterion(key)?.type) === 'predefined'">
                <div class="predef-controls">
                  <button *ngFor="let opt of getCriterion(key)?.options"
                          title="{{opt}}"
                          (click)="$event.stopPropagation(); setPredefined(cell, key, opt)">{{opt.charAt(0)}}</button>
                  <span class="selected-value">{{ cell.student.counters[key] ? (cell.student.counters[key]) : 'N/A' }}</span>
                </div>
              </ng-container>
            </div>
          </div>
        </ng-container>

      </div>
    </ng-container>
  </ng-container>
</div>
