<div class="grid" *ngIf="activeView"
     [style.gridTemplateRows]="'repeat(' + activeClass.rows + ', minmax(80px, auto))'"
     [style.gridTemplateColumns]="'repeat(' + activeClass.cols + ', 1fr)'">
  <ng-container *ngFor="let row of activeView.grid; let rIdx = index">
    <ng-container *ngFor="let cell of row; let cIdx = index">
      <div class="cell" #cellDiv
           [class.filled]="!!cell.student"
           (click)="onCellClick(cell)"
           (dragover)="$event.preventDefault()"
           (drop)="onDrop(cell)">

        <ng-container *ngIf="cell.student">
          <div class="student-header">
        <span class="name"
          [attr.draggable]="editMode.isEnabled ? true : null"
          (dragstart)="editMode.isEnabled && onDragStart($event, cell)"
          (dblclick)="openNotesDialog(cell)"
        >{{cell.student.name}}</span>
        <!-- Indicator for existing notes -->
        <span class="notes-indicator" *ngIf="hasNotes(cell.student)"></span>
      <button class="del-btn" *ngIf="editMode.isEnabled" (click)="$event.stopPropagation(); confirmDeleteStudent(cell)">✕</button>
        </div>

          <div class="counter-area">
            <div *ngFor="let key of getStudentCounterKeys(cell.student); let i = index"
                 class="criterion-line"
                 [ngClass]="{'odd': i % 2 === 0, 'even': i % 2 !== 0}">
              <div class="crit-name">{{key}}</div>

              <!-- Counter type -->
              <ng-container *ngIf="(getCriterion(key)?.type) === 'counter'">
                <!-- Counter controls: red background when value is zero -->
                <div class="counter-controls" [ngClass]="{'zero-bg': cell.student.counters[key] === 0}">
                  <button (click)="$event.stopPropagation(); decrementKey(cell, key)">-</button>
                  <span class="count-value">{{cell.student.counters[key]}}</span>
                  <button (click)="$event.stopPropagation(); incrementKey(cell, key)">+</button>
                </div>
              </ng-container>

              <!-- Predefined type -->
              <ng-container *ngIf="(getCriterion(key)?.type) === 'predefined'">
                <div class="predef-controls">
                  <button *ngFor="let opt of getCriterion(key)?.options"
                          title="{{opt}}"
                          (click)="$event.stopPropagation(); setPredefined(cell, key, opt)"
                          [class.selected]="cell.student.counters[key] === opt">{{opt.charAt(0)}}</button>
                </div>
              </ng-container>
            </div>
          </div>
        </ng-container>

      </div>
  </ng-container>
</ng-container>

<!-- Notes dialog – shown when a student cell is being edited -->
<div class="notes-modal" *ngIf="editingNotesCell">
  <div class="modal-content">
    <h3>Student Notes</h3>
    <textarea [(ngModel)]="notesEditValue" rows="8" style="width:100%;"></textarea>
    <div class="modal-actions" style="margin-top:8px; text-align:right;">
      <button (click)="cancelNotes()">Cancel</button>
      <button (click)="saveNotes()" style="margin-left:4px;">Save</button>
    </div>
  </div>
</div>
</div>
